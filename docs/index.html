<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andrada - KI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§¬</text></svg>">
    <style>
        :root {
            --primary: #1a365d;
            --accent: #2c5282;
            --success: #276749;
            --warning: #c05621;
            --light: #f7fafc;
            --border: #e2e8f0;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light);
            color: #2d3748;
            line-height: 1.6;
            padding: 1rem;
        }
        .top-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .left-column {
            min-width: 0;
        }
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        header {
            background: var(--primary);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        .stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .stat {
            background: rgba(255,255,255,0.15);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .stat strong {
            font-size: 1.2rem;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }
        .section.applied {
            border-left: 4px solid var(--success);
        }
        .section.applied h2 {
            color: var(--success);
        }
        .section.irrelevant {
            border-left: 4px solid #a0aec0;
        }
        .section.irrelevant h2 {
            color: #718096;
        }
        .job-list {
            list-style: none;
        }
        .job {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .job:last-child {
            border-bottom: none;
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
        }
        .job-title {
            font-weight: 600;
            color: var(--accent);
            text-decoration: none;
            flex: 1;
        }
        .job-title:hover {
            text-decoration: underline;
        }
        .job-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }
        .btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .btn-applied {
            background: #c6f6d5;
            color: var(--success);
        }
        .btn-irrelevant {
            background: #e2e8f0;
            color: #718096;
        }
        .btn-undo {
            background: #fed7d7;
            color: #c53030;
        }
        .job-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #718096;
            margin-top: 0.5rem;
        }
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-high {
            background: #fed7d7;
            color: #c53030;
        }
        .badge-closing {
            background: #feebc8;
            color: var(--warning);
        }
        .badge-keyword {
            background: #e2e8f0;
            color: #4a5568;
        }
        .keywords {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        .empty {
            color: #a0aec0;
            text-align: center;
            padding: 1rem;
            font-size: 0.9rem;
        }
        footer {
            text-align: center;
            color: #a0aec0;
            font-size: 0.8rem;
            margin-top: 2rem;
        }
        footer a {
            color: var(--accent);
        }
        .easter-egg {
            text-align: center;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }
        .easter-egg img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid white;
            margin-bottom: 0.75rem;
            object-fit: cover;
        }
        .easter-egg p {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .right-job {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .right-job:last-child {
            border-bottom: none;
        }
        .right-job-title {
            font-weight: 500;
            color: var(--accent);
            text-decoration: none;
            display: block;
            margin-bottom: 0.25rem;
        }
        .right-job-title:hover {
            text-decoration: underline;
        }
        .right-job-meta {
            font-size: 0.75rem;
            color: #718096;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .right-column {
                order: -1;
            }
        }
        @media (max-width: 600px) {
            body {
                padding: 0.5rem;
            }
            header {
                padding: 1rem;
            }
            .job-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
            .job-header {
                flex-direction: column;
            }
            .job-actions {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="top-container">
        <div class="easter-egg">
            <img src="andrada.jpeg" alt="Andrada Balmez">
            <p>Future PhD Student: Andrada Balmez</p>
        </div>
        <header>
            <h1>KI Research Position Tracker</h1>
            <p class="subtitle">PhD &amp; Research positions at Karolinska Institutet</p>
            <p class="subtitle">Focus: iPSC/Organoids, Single-cell, Neuroscience</p>
            <div class="stats">
                <div class="stat"><strong id="stat-total">17</strong> matching positions</div>
                <div class="stat"><strong id="stat-closing">7</strong> closing soon</div>
                <div class="stat"><strong id="stat-high">8</strong> high priority</div>
            </div>
        </header>
    </div>

    <div class="main-layout">
        <div class="left-column" id="main-jobs">
            <div class="section"><p class="empty">Loading...</p></div>
        </div>
        <div class="right-column">
            <div class="section applied">
                <h2>Applied (<span id="applied-count">0</span>)</h2>
                <ul class="job-list" id="applied-list">
                    <li class="empty" id="applied-empty">No applications yet</li>
                </ul>
            </div>
            <div class="section irrelevant">
                <h2>Irrelevant (<span id="irrelevant-count">0</span>)</h2>
                <ul class="job-list" id="irrelevant-list">
                    <li class="empty" id="irrelevant-empty">None marked</li>
                </ul>
            </div>
        </div>
    </div>

    <footer>
        <p>Last updated: 2026-02-04 08:32 CET</p>
        <p>Subscribe to notifications: <a href="https://ntfy.sh/andrada-ki-jobs">ntfy.sh/andrada-ki-jobs</a></p>
        <p id="sync-status" style="font-size: 0.7rem; margin-top: 0.5rem; color: #718096;"></p>
    </footer>

    <script>
        const allJobs = [{"id": "ki_doktorand_896801", "title": "Doctoral position in\u201dNew Oligonucleotide Constructs for Enhanced Delivery\u201d", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:896801/", "deadline": "28.Feb.2026", "deadline_date": "2026-02-28T00:00:00", "source": "ki_doktorand", "matched_keywords": ["genetic engineering"], "is_high_priority": false, "closing_soon": false}, {"id": "ki_doktorand_880275", "title": "Doctoral (PhD) student position in Genetic Modification of NK cells", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:880275/", "deadline": "17.Feb.2026", "deadline_date": "2026-02-17T00:00:00", "source": "ki_doktorand", "matched_keywords": ["crispr", "cell culture", "molecular biology", "immunology", "immunotherapies", "genetic engineering"], "is_high_priority": false, "closing_soon": false}, {"id": "ki_doktorand_879039", "title": "Doctoral (PhD) student position in online autism support", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:879039/", "deadline": "22.Feb.2026", "deadline_date": "2026-02-22T00:00:00", "source": "ki_doktorand", "matched_keywords": ["neurodevelopmental"], "is_high_priority": true, "closing_soon": false}, {"id": "ki_doktorand_896279", "title": "Doctoral (PhD) student position in Virology and Immunology", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:896279/", "deadline": "06.Feb.2026", "deadline_date": "2026-02-06T00:00:00", "source": "ki_doktorand", "matched_keywords": ["immunology"], "is_high_priority": false, "closing_soon": true}, {"id": "ki_doktorand_894301", "title": "Examining long non-coding RNA function in human adipocytes", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:894301/", "deadline": "09.Feb.2026", "deadline_date": "2026-02-09T00:00:00", "source": "ki_doktorand", "matched_keywords": ["molecular biology", "genetics"], "is_high_priority": false, "closing_soon": true}, {"id": "ki_doktorand_892468", "title": "PhD position in Network Medicine", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:892468/", "deadline": "05.Feb.2026", "deadline_date": "2026-02-05T00:00:00", "source": "ki_doktorand", "matched_keywords": ["genetics"], "is_high_priority": false, "closing_soon": true}, {"id": "ki_doktorand_891486", "title": "Doctoral position in Systems Neuroscience", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:891486/", "deadline": "10.Feb.2026", "deadline_date": "2026-02-10T00:00:00", "source": "ki_doktorand", "matched_keywords": ["neuroscience", "single-cell"], "is_high_priority": true, "closing_soon": true}, {"id": "ki_doktorand_892020", "title": "Doctoral (PhD) student position in molecular epidemiology with focus on cardiovascular diseases", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:892020/", "deadline": "13.Feb.2026", "deadline_date": "2026-02-13T00:00:00", "source": "ki_doktorand", "matched_keywords": ["bioinformatics"], "is_high_priority": false, "closing_soon": false}, {"id": "ki_doktorand_879932", "title": "PhD position \u2013 Computational Neuroscience and Systems Biology. Theme: Neural dynamics underlying survival behaviors", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:879932/", "deadline": "05.Apr.2026", "deadline_date": "2026-04-05T00:00:00", "source": "ki_doktorand", "matched_keywords": ["neuroscience"], "is_high_priority": true, "closing_soon": false}, {"id": "ki_doktorand_877859", "title": "PhD position \u2013 Bioengineering and Neuroscience Theme: Neural basis of survival behaviors", "url": "https://kidoktorand.varbi.com/en/what:job/jobID:877859/", "deadline": "05.Apr.2026", "deadline_date": "2026-04-05T00:00:00", "source": "ki_doktorand", "matched_keywords": ["neuroscience"], "is_high_priority": true, "closing_soon": false}, {"id": "ki_varbi_899914", "title": "Post doctoral bioinformatics studies in vaccine immunology (scholarship)", "url": "https://ki.varbi.com/en/what:job/jobID:899914/", "deadline": "2026-02-16", "deadline_date": "2026-02-16T00:00:00", "source": "ki_varbi", "matched_keywords": ["bioinformatics", "immunology"], "is_high_priority": false, "closing_soon": false}, {"id": "ki_varbi_899166", "title": "Research assistant in reproductive immunology", "url": "https://ki.varbi.com/en/what:job/jobID:899166/", "deadline": "2026-02-13", "deadline_date": "2026-02-13T00:00:00", "source": "ki_varbi", "matched_keywords": ["immunology"], "is_high_priority": false, "closing_soon": false}, {"id": "ki_varbi_898365", "title": "Research Assistant in Spatial Transcriptomics of Human Adipose Tissue", "url": "https://ki.varbi.com/en/what:job/jobID:898365/", "deadline": "2026-02-11", "deadline_date": "2026-02-11T00:00:00", "source": "ki_varbi", "matched_keywords": ["spatial transcriptomics"], "is_high_priority": true, "closing_soon": true}, {"id": "ki_varbi_889495", "title": "Research Specialist in Pluripotent Stem Cell derived Cell Therapies", "url": "https://ki.varbi.com/en/what:job/jobID:889495/", "deadline": "2026-02-10", "deadline_date": "2026-02-10T00:00:00", "source": "ki_varbi", "matched_keywords": ["stem cell"], "is_high_priority": true, "closing_soon": true}, {"id": "ki_varbi_896298", "title": "Research Assistant in Immunology", "url": "https://ki.varbi.com/en/what:job/jobID:896298/", "deadline": "2026-02-10", "deadline_date": "2026-02-10T00:00:00", "source": "ki_varbi", "matched_keywords": ["immunology"], "is_high_priority": false, "closing_soon": true}, {"id": "ki_varbi_895416", "title": "Lab manager in organoid technology, endoderm biology and omics.", "url": "https://ki.varbi.com/en/what:job/jobID:895416/", "deadline": "2026-02-14", "deadline_date": "2026-02-14T00:00:00", "source": "ki_varbi", "matched_keywords": ["organoid"], "is_high_priority": true, "closing_soon": false}, {"id": "ki_varbi_893855", "title": "Research Assistant in Neuroscience", "url": "https://ki.varbi.com/en/what:job/jobID:893855/", "deadline": "2026-02-16", "deadline_date": "2026-02-16T00:00:00", "source": "ki_varbi", "matched_keywords": ["neuroscience"], "is_high_priority": true, "closing_soon": false}];
        const sourceNames = {
            'ki_doktorand': 'KI Doctoral Positions',
            'ki_varbi': 'KI Staff Positions',
            'academic_positions': 'Academic Positions'
        };

        // Supabase config
        const SUPABASE_URL = 'https://lbhnbdocsmjpltxhmxek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxiaG5iZG9jc21qcGx0eGhteGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjM5OTQsImV4cCI6MjA4NTUzOTk5NH0.b8lBAbC_7Ldtzof7vyA8y6SkN4kSlj5lMxroBpjVIdE';

        let applied = [];
        let irrelevant = [];
        let saveTimeout = null;

        function setSyncStatus(msg) {
            document.getElementById('sync-status').textContent = msg;
        }

        // Load state from Supabase
        async function loadState() {
            setSyncStatus('Loading...');
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/job_state?id=eq.default&select=applied,irrelevant`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.length > 0) {
                        applied = data[0].applied || [];
                        irrelevant = data[0].irrelevant || [];
                    }
                    setSyncStatus('Synced');
                } else {
                    throw new Error('Failed to load');
                }
            } catch (e) {
                console.error('Load error:', e);
                setSyncStatus('Offline - using local data');
                applied = JSON.parse(localStorage.getItem('ki-jobs-applied') || '[]');
                irrelevant = JSON.parse(localStorage.getItem('ki-jobs-irrelevant') || '[]');
            }
            render();
        }

        // Save state to Supabase (debounced)
        function saveState() {
            // Always save to localStorage as backup
            localStorage.setItem('ki-jobs-applied', JSON.stringify(applied));
            localStorage.setItem('ki-jobs-irrelevant', JSON.stringify(irrelevant));

            // Debounce cloud save
            if (saveTimeout) clearTimeout(saveTimeout);
            setSyncStatus('Saving...');
            saveTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`${SUPABASE_URL}/rest/v1/job_state?id=eq.default`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ applied, irrelevant })
                    });
                    if (res.ok) {
                        setSyncStatus('Synced');
                    } else {
                        throw new Error('Save failed');
                    }
                } catch (e) {
                    console.error('Save error:', e);
                    setSyncStatus('Sync error - saved locally');
                }
            }, 500);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Not specified';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        function createJobCard(job, showUndo = false, undoAction = null) {
            const badges = [];
            if (job.is_high_priority) badges.push('<span class="badge badge-high">High Priority</span>');
            if (job.closing_soon) badges.push('<span class="badge badge-closing">Closing Soon</span>');

            const keywords = job.matched_keywords.map(k => `<span class="badge badge-keyword">${k}</span>`).join('');
            const deadline = formatDate(job.deadline_date || job.deadline);

            let actions = '';
            if (showUndo) {
                actions = `<button class="btn btn-undo" onclick="undoJob('${job.id}', '${undoAction}')">Undo</button>`;
            } else {
                actions = `
                    <button class="btn btn-applied" onclick="markApplied('${job.id}')">Applied</button>
                    <button class="btn btn-irrelevant" onclick="markIrrelevant('${job.id}')">Irrelevant</button>
                `;
            }

            return `
                <li class="job" data-job-id="${job.id}">
                    <div class="job-header">
                        <a href="${job.url}" class="job-title" target="_blank">${job.title}</a>
                        <div class="job-actions">${actions}</div>
                    </div>
                    <div class="job-meta">
                        <span>Deadline: ${deadline}</span>
                        ${badges.join(' ')}
                    </div>
                    <div class="keywords">${keywords}</div>
                </li>
            `;
        }

        function createRightJobCard(job, listType) {
            const deadline = formatDate(job.deadline_date || job.deadline);
            return `
                <li class="right-job" data-job-id="${job.id}">
                    <a href="${job.url}" class="right-job-title" target="_blank">${job.title}</a>
                    <div class="right-job-meta">
                        <span>${deadline}</span>
                        <button class="btn btn-undo" onclick="undoJob('${job.id}', '${listType}')">Undo</button>
                    </div>
                </li>
            `;
        }

        function markApplied(jobId) {
            if (!applied.includes(jobId)) {
                applied.push(jobId);
                irrelevant = irrelevant.filter(id => id !== jobId);
                saveState();
                render();
            }
        }

        function markIrrelevant(jobId) {
            if (!irrelevant.includes(jobId)) {
                irrelevant.push(jobId);
                applied = applied.filter(id => id !== jobId);
                saveState();
                render();
            }
        }

        function undoJob(jobId, listType) {
            if (listType === 'applied') {
                applied = applied.filter(id => id !== jobId);
            } else {
                irrelevant = irrelevant.filter(id => id !== jobId);
            }
            saveState();
            render();
        }

        function render() {
            const mainJobs = allJobs.filter(j => !applied.includes(j.id) && !irrelevant.includes(j.id));
            const appliedJobs = allJobs.filter(j => applied.includes(j.id));
            const irrelevantJobs = allJobs.filter(j => irrelevant.includes(j.id));

            // Group main jobs by source
            const bySource = {};
            mainJobs.forEach(job => {
                if (!bySource[job.source]) bySource[job.source] = [];
                bySource[job.source].push(job);
            });

            // Render main jobs
            const mainContainer = document.getElementById('main-jobs');
            if (mainJobs.length === 0) {
                mainContainer.innerHTML = '<div class="section"><p class="empty">No matching positions found. Check back later!</p></div>';
            } else {
                let html = '';
                for (const [source, jobs] of Object.entries(bySource)) {
                    const sourceName = sourceNames[source] || source;
                    html += `<div class="section"><h2>${sourceName} (${jobs.length})</h2><ul class="job-list">`;
                    jobs.forEach(job => {
                        html += createJobCard(job);
                    });
                    html += '</ul></div>';
                }
                mainContainer.innerHTML = html;
            }

            // Render applied
            const appliedList = document.getElementById('applied-list');
            const appliedEmpty = document.getElementById('applied-empty');
            document.getElementById('applied-count').textContent = appliedJobs.length;
            if (appliedJobs.length === 0) {
                appliedList.innerHTML = '<li class="empty">No applications yet</li>';
            } else {
                appliedList.innerHTML = appliedJobs.map(j => createRightJobCard(j, 'applied')).join('');
            }

            // Render irrelevant
            const irrelevantList = document.getElementById('irrelevant-list');
            document.getElementById('irrelevant-count').textContent = irrelevantJobs.length;
            if (irrelevantJobs.length === 0) {
                irrelevantList.innerHTML = '<li class="empty">None marked</li>';
            } else {
                irrelevantList.innerHTML = irrelevantJobs.map(j => createRightJobCard(j, 'irrelevant')).join('');
            }

            // Update stats
            document.getElementById('stat-total').textContent = mainJobs.length;
            document.getElementById('stat-closing').textContent = mainJobs.filter(j => j.closing_soon).length;
            document.getElementById('stat-high').textContent = mainJobs.filter(j => j.is_high_priority).length;
        }

        // Initial load from cloud
        loadState();
    </script>
</body>
</html>
